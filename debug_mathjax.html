<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MathJax Debug Test</title>
    <script>
        // MathJax configuration
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            svg: {
                fontCache: 'global'
            }
            // Removed the startup configuration that might be causing issues
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>
<body>
    <h1>MathJax Debug Test</h1>
    
    <div id="content">
        <p>When $a \ne 0$, the solution to the equation $ax^2 + bx + c = 0$ is:</p>
        <p>$$x = {-b \pm \sqrt{b^2-4ac} \over 2a}$$</p>
    </div>
    
    <button onclick="renderMath()">Render MathJax</button>
    <button onclick="debugElements()">Debug Elements</button>
    <button onclick="testConversion()">Test SVG to Base64 Conversion</button>
    <div id="result"></div>
    
    <script>
        // Utility function to convert SVG to base64 data URL
        function svgToBase64DataURL(svgElement) {
            try {
                // Properly serialize the SVG element with all namespaces
                const serializer = new XMLSerializer();
                let svgString = serializer.serializeToString(svgElement);
                
                console.log('Original SVG:', svgString.substring(0, 200) + '...');
                
                // Ensure SVG has proper namespace and other required attributes
                if (!svgString.includes('xmlns="http://www.w3.org/2000/svg"')) {
                    svgString = svgString.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
                }
                
                // Add xmlns:xlink if not present (for MathJax fonts)
                if (svgString.includes('xlink:href') && !svgString.includes('xmlns:xlink="http://www.w3.org/1999/xlink"')) {
                    svgString = svgString.replace('<svg', '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
                }
                
                // Add XML declaration for better compatibility
                if (!svgString.startsWith('<?xml')) {
                    svgString = '<?xml version="1.0" standalone="no"?>\r\n' + svgString;
                }
                
                console.log('Processed SVG:', svgString.substring(0, 200) + '...');
                
                // Convert to base64 using btoa (more reliable than encodeURIComponent)
                // First, we need to handle UTF-8 encoding properly
                const base64Encoded = btoa(unescape(encodeURIComponent(svgString)));
                const dataURL = `data:image/svg+xml;base64,${base64Encoded}`;
                
                console.log('Data URL length:', dataURL.length);
                
                return dataURL;
            } catch (error) {
                console.warn('Failed to convert SVG to base64:', error);
                return null;
            }
        }
        
        function renderMath() {
            // Check if MathJax is loaded and ready
            if (typeof window.MathJax !== 'undefined') {
                // Wait for MathJax to be fully loaded
                if (window.MathJax.startup && window.MathJax.startup.promise) {
                    window.MathJax.startup.promise.then(() => {
                        // MathJax is ready, now render
                        if (window.MathJax.typesetPromise) {
                            window.MathJax.typesetPromise([document.getElementById('content')]).then(() => {
                                console.log('MathJax rendering completed');
                                debugElements();
                            }).catch((error) => {
                                console.warn('MathJax rendering failed:', error);
                            });
                        }
                    }).catch((error) => {
                        console.warn('MathJax startup failed:', error);
                    });
                } else {
                    // Fallback if startup.promise is not available
                    setTimeout(() => {
                        if (window.MathJax.typesetPromise) {
                            window.MathJax.typesetPromise([document.getElementById('content')]).then(() => {
                                console.log('MathJax rendering completed');
                                debugElements();
                            }).catch((error) => {
                                console.warn('MathJax rendering failed:', error);
                            });
                        }
                    }, 1000);
                }
            } else {
                console.warn('MathJax is not loaded');
            }
        }
        
        function debugElements() {
            const content = document.getElementById('content');
            console.log('Content HTML:', content.innerHTML);
            
            // Check for MathJax elements
            const mathJaxElements = content.querySelectorAll('mjx-container[jax="SVG"]');
            console.log('Found', mathJaxElements.length, 'MathJax SVG containers');
            
            mathJaxElements.forEach((container, index) => {
                console.log('Container', index, ':', container);
                const svg = container.querySelector('svg');
                if (svg) {
                    console.log('SVG', index, ':', svg);
                    console.log('SVG attributes:', svg.attributes);
                } else {
                    console.log('No SVG found in container', index);
                }
            });
        }
        
        function testConversion() {
            const content = document.getElementById('content');
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content.innerHTML;
            
            // Convert MathJax SVG elements to images for better clipboard compatibility
            const mathJaxElements = tempDiv.querySelectorAll('mjx-container[jax="SVG"]');
            
            console.log('Found', mathJaxElements.length, 'MathJax elements');
            
            mathJaxElements.forEach((container, index) => {
                const svg = container.querySelector('svg');
                if (svg) {
                    try {
                        // Convert SVG to base64 data URL using our reusable function
                        const dataURL = svgToBase64DataURL(svg);
                        
                        if (dataURL) {
                            // Create img element to replace the MathJax container
                            const img = document.createElement('img');
                            img.src = dataURL;
                            img.alt = 'Math formula';
                            img.style.verticalAlign = 'middle';
                            img.setAttribute('data-math', 'true'); // Mark as math element for debugging
                            
                            // Copy dimensions and important attributes from original SVG
                            const width = svg.getAttribute('width');
                            const height = svg.getAttribute('height');
                            const style = svg.getAttribute('style');
                            
                            if (width) img.style.width = width;
                            if (height) img.style.height = height;
                            if (style) img.setAttribute('style', style + '; vertical-align: middle;');
                            
                            // Replace the MathJax container with the image
                            container.parentNode.replaceChild(img, container);
                            
                            console.log('Successfully converted MathJax element', index);
                        }
                    } catch (error) {
                        console.warn('Failed to convert MathJax SVG to image:', error);
                        // Keep original structure as fallback
                    }
                } else {
                    console.warn('No SVG found in MathJax container', index);
                }
            });
            
            // Display the result
            document.getElementById('result').innerHTML = tempDiv.innerHTML;
            
            // Log the result for debugging
            console.log('Conversion completed. Result HTML:', tempDiv.innerHTML.substring(0, 500) + '...');
        }
    </script>
</body>
</html>